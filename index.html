<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMART AI SCHEDULER 24H</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a0a; --accent-blue: #0070FF; --text-silver: #f5f5f5;
            --metal-gradient: linear-gradient(145deg, #444444, #222222);
            --location-color: #E0E0E0; --ai-orange: #FF9500;
        }
        body { background-color: var(--bg-dark); color: var(--text-silver); font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; margin: 0; padding: 5px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; box-sizing: border-box; }
        
        .header-container { text-align: center; padding: 12px 0; background: linear-gradient(145deg, #1a1a1a, #000000); border-bottom: 1px solid #333; flex-shrink: 0; position: relative; }
        #copy-status-bar { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--ai-orange); color: #000; font-weight: 900; align-items: center; justify-content: center; z-index: 100; font-size: 0.95rem; cursor: pointer; }

        .header-title { font-size: 1.6rem; font-weight: 800; color: #fff; letter-spacing: 2px; margin: 0; text-transform: uppercase; }
        .nav-container { display: flex; justify-content: center; align-items: center; gap: 25px; margin-top: 8px; }
        .nav-btn { background: var(--metal-gradient); color: #fff; border: 1px solid #555; border-radius: 6px; padding: 4px 12px; cursor: pointer; }
        
        .calendar-container { flex: 1; margin-top: 5px; display: flex; flex-direction: column; background: #000; border: 1px solid #222; overflow: hidden; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); height: 100%; gap: 1px; background: #222; }
        .cal-header { color: #888; font-weight: 800; padding: 4px 0; text-align: center; font-size: 0.7rem; background: #111; line-height: 1; }

        .cal-day { background: #0a0a0a; padding: 5px; cursor: pointer; display: flex; flex-direction: column; position: relative; min-height: 0; overflow: hidden; transition: 0.2s; }
        .cal-day:active { background: #1a1a1a; }
        .cal-day.prev-month, .cal-day.next-month { opacity: 0; pointer-events: none; }
        
        .day-num { font-size: 1.1rem; font-weight: 800; color: #fff; position: absolute; top: 5px; left: 8px; z-index: 2; }
        .weather-badge-main { align-self: flex-end; text-align: right; font-size: 1.0rem; line-height: 1.2; font-weight: 900; z-index: 2; }
        .w-line { display: flex; justify-content: flex-end; align-items: center; white-space: nowrap; height: 1.2rem; } 
        .w-loc-inline { color: var(--location-color); font-size: 0.85rem; font-weight: 900; margin-right: 5px; opacity: 0.8; }

        .time-bar { display: grid; grid-template-columns: repeat(24, 1fr); gap: 0.5px; height: 8px; background: #151515; margin-top: auto; border-radius: 1px; }
        
        /* Î™®Îã¨ Í≥µÌÜµ */
        .modal, .ai-modal, #map-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content, .ai-content { background: #111; width: 95%; max-width: 480px; padding: 12px; border: 1px solid #333; border-radius: 12px; }
        
        #map-overlay { z-index: 4000; background: #000; flex-direction: column; padding: 10px; box-sizing: border-box; }
        #map-container { width: 100%; flex: 1; border-radius: 12px; border: 1px solid #444; margin: 10px 0; }

        .f-btn { flex: 1; border-radius: 6px; font-size: 0.7rem; font-weight: 900; border: 1px solid #444; cursor: pointer; background: var(--metal-gradient); color: #fff; }
        .m-btn { background: var(--metal-gradient); color: white; height: 44px; border-radius: 8px; border: 1px solid #444; cursor: pointer; font-weight: 800; }
        #time-picker { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; margin-bottom: 8px; background: #000; padding: 6px; border-radius: 6px; }

        .stamp-mode-active { cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'><text y='20' font-size='20'>üí∞</text></svg>") 10 10, cell !important; }
    </style>
</head>
<body id="main-body">

    <div class="header-container">
        <div id="copy-status-bar" onclick="deactivateStampMode()">[üí∞Ïä§ÌÉ¨ÌîÑ Î™®Îìú ÌôúÏÑ±] Îã¨Î†•ÏùÑ ÌÅ¥Î¶≠Ìï¥ Ï∞çÏúºÏÑ∏Ïöî. (Ï¢ÖÎ£å: ESC)</div>
        <div class="header-title">SMART SCHEDULER 24H</div>
        <div class="nav-container">
            <button class="nav-btn" onclick="changeMonth(-1)">PREV</button>
            <div id="year-title" style="color:var(--accent-blue); font-weight:bold; font-size:1.3rem; min-width:130px; text-align:center;"></div>
            <button class="nav-btn" onclick="changeMonth(1)">NEXT</button>
        </div>
    </div>

    <div class="calendar-container" id="calendar-box"><div id="main-calendar" class="cal-grid"></div></div>

    <div id="ai-modal" class="ai-modal">
        <div class="ai-content">
            <h3 style="color:var(--ai-orange); margin-top:0;">ü§ñ AI ÏßÄÎä•Ìòï ÎπÑÏÑú (24H)</h3>
            <textarea id="ai-command" style="width:100%; background:#000; border:1px solid #333; color:#fff; padding:12px; border-radius:8px; margin-bottom:15px; box-sizing:border-box;" rows="4" placeholder="Ïòà: Îß§Ï£º Í∏àÏöîÏùº ÌÅ¥ÎûòÏãùÍ∏∞ÌÉÄ Î†àÏä® Ïò§Ï†Ñ10ÏãúÎ∂ÄÌÑ∞ Ïò§ÌõÑ1ÏãúÍπåÏßÄ"></textarea>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="m-btn" onclick="processAICommand()" style="background:var(--ai-orange); color:#000;">Î™ÖÎ†π Ïã§Ìñâ</button>
                <button class="m-btn" onclick="closeAI()">Îã´Í∏∞</button>
            </div>
        </div>
    </div>

    <div id="input-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 id="modal-date-title" style="margin:0;"></h3>
                <div id="modal-weather-info" style="color:var(--accent-blue); font-weight:900;"></div>
            </div>
            <div id="time-picker"></div>
            <div style="display: flex; gap: 8px; margin-bottom: 12px; height: 140px;">
                <div id="color-palette" style="display: grid; grid-template-columns: repeat(3, 1fr); width: 85px; gap: 4px;"></div>
                <div style="flex:1; display:flex; flex-direction:column;">
                    <textarea id="ev-name" style="flex:1; background:#000; border:1px solid #333; color:#fff; padding:10px; border-radius:8px; resize:none;" placeholder="ÎÇ¥Ïö© ÏûÖÎ†•..."></textarea>
                    <button class="m-btn" style="width:100%; color:var(--ai-orange); height:32px; font-size:0.75rem; margin-top:4px;" onclick="activateStampMode()">COPY ALL</button>
                </div>
                <div class="function-btns" style="display:flex; flex-direction:column; gap:4px; width:100px;">
                    <button class="f-btn" onclick="openAI()" style="color:var(--ai-orange) !important;">AI ÎπÑÏÑú</button>
                    <button id="loc-set-btn" class="f-btn" onclick="openMap()">LOC SET</button>
                    <button id="directions-btn" class="f-btn" onclick="goDirections()" style="color:#5AC8FA !important;">GET DIR</button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;">
                <button onclick="closeModal()" class="m-btn" style="background:none;">CLOSE</button>
                <button id="mode-add" onclick="handleModeBtn('add')" class="m-btn">ADD</button>
                <button id="mode-edit" onclick="handleModeBtn('edit')" class="m-btn">EDIT</button>
                <button id="mode-del" onclick="handleModeBtn('del')" class="m-btn">DEL</button>
            </div>
        </div>
    </div>

    <div id="map-overlay">
        <div id="addr-display" style="color:#fff; font-weight:bold; text-align:center;">Ï£ºÏÜåÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</div>
        <div id="map-container"></div>
        <div style="display:flex; gap:10px; width:100%; max-width:480px;">
            <button class="m-btn" style="flex:1" onclick="closeMap()">CANCEL</button>
            <button class="m-btn" style="flex:1; background:var(--accent-blue)" onclick="confirmMapLocation()">CONFIRM</button>
        </div>
    </div>

    <script>
        const storageKeyPrefix = 'smart_v24h_v2_'; 
        let viewDate = new Date(2026, 0, 1);
        let currentDay = 0, startSlot = null, endSlot = null, selectedColor = '#0070FF', editingIdx = -1, currentMode = 'add';
        let map, marker, tempCoords = null, tempWeather = {}, tempAddr = "";
        let memoEvents = [], memoCoords = null, memoAddr = "", isStampMode = false;
        
        const weatherMap = { 0: "‚òÄÔ∏è", 1: "üå§Ô∏è", 2: "‚õÖ", 3: "‚òÅÔ∏è", 45: "üå´Ô∏è", 51: "üå¶Ô∏è", 61: "üåßÔ∏è", 71: "‚ùÑÔ∏è", 95: "‚õàÔ∏è" };
        let globalLastCoords = { lat: 37.4979, lng: 127.0276 }; 
        let globalLastAddr = "Í∞ïÎÇ®Íµ¨"; 
        let defaultWeather = null;

        function getStore() { 
            const key = storageKeyPrefix + viewDate.getFullYear() + '_' + (viewDate.getMonth() + 1); 
            return { key, data: JSON.parse(localStorage.getItem(key) || '{}') }; 
        }

        // [AI ÎπÑÏÑú ÏóîÏßÑ]
        async function processAICommand() {
            const cmd = document.getElementById('ai-command').value;
            if(!cmd) return;
            const days = {"Ïùº":0, "Ïõî":1, "Ìôî":2, "Ïàò":3, "Î™©":4, "Í∏à":5, "ÌÜ†":6};
            let targetDayNum = -1;
            for(let key in days) { if(cmd.includes(key)) targetDayNum = days[key]; }

            function parseHour(text) {
                const match = text.match(/(\d+)Ïãú/);
                if(!match) return null;
                let h = parseInt(match[1]);
                if(text.includes("Ïò§ÌõÑ") && h < 12) h += 12;
                if(text.includes("Ïò§Ï†Ñ") && h === 12) h = 0;
                return h;
            }

            const parts = cmd.split("Î∂ÄÌÑ∞");
            let sH = 0, eH = 0;
            if(parts.length > 1) {
                sH = parseHour(parts[0]);
                eH = parseHour(parts[1]);
            }

            if(targetDayNum !== -1 && sH !== null && eH !== null) {
                const { key, data } = getStore();
                const lastD = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
                const name = cmd.split("ÏöîÏùº")[1]?.replace(/Ïò§Ï†Ñ|Ïò§ÌõÑ|Î∂ÄÌÑ∞|ÍπåÏßÄ|\d+Ïãú/g, "").trim() || "AI ÏùºÏ†ï";
                
                for(let d=1; d<=lastD; d++) {
                    if(new Date(viewDate.getFullYear(), viewDate.getMonth(), d).getDay() === targetDayNum) {
                        if(!data[d]) data[d] = { events: [], weather: { ...defaultWeather, coords: globalLastCoords, addr: globalLastAddr } };
                        data[d].events.push({ name, start: sH, end: eH, color: "#AF52DE" });
                    }
                }
                localStorage.setItem(key, JSON.stringify(data));
                renderCalendar();
                alert(`${sH}Ïãú~${eH}Ïãú ÏùºÍ¥Ñ Îì±Î°ù ÏôÑÎ£å!`);
                closeAI();
            }
        }

        function openAI() { closeModal(); document.getElementById('ai-modal').style.display = 'flex'; }
        function closeAI() { document.getElementById('ai-modal').style.display = 'none'; }

        // [ÏúÑÏπò ÏÑ§Ï†ï ÏóîÏßÑ - Î®πÌÜµ Î∞©ÏßÄ Î≥¥Ï†ï]
        function openMap() {
            closeModal(); closeAI(); // Í∏∞Ï°¥ Î™®Îã¨ Î™®Îëê Îã´Í∏∞
            document.getElementById('map-overlay').style.display = 'flex';
            
            const targetLat = globalLastCoords.lat;
            const targetLng = globalLastCoords.lng;

            setTimeout(() => {
                if (!map) {
                    map = L.map('map-container').setView([targetLat, targetLng], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    map.on('click', (e) => {
                        const { lat, lng } = e.latlng;
                        if (marker) map.removeLayer(marker);
                        marker = L.marker([lat, lng]).addTo(map);
                        tempCoords = { lat, lng };
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                            .then(res => res.json()).then(d => {
                                tempAddr = d.display_name;
                                document.getElementById('addr-display').innerText = "üìç " + tempAddr.split(',').slice(0,2).join(',');
                            });
                    });
                } else {
                    map.setView([targetLat, targetLng], 13);
                }
                if (marker) map.removeLayer(marker);
                marker = L.marker([targetLat, targetLng]).addTo(map);
                map.invalidateSize();
            }, 200);
        }

        function closeMap() { document.getElementById('map-overlay').style.display = 'none'; openModal(currentDay); }

        async function confirmMapLocation() {
            if(tempCoords) {
                globalLastCoords = tempCoords;
                globalLastAddr = tempAddr;
                const { key, data } = getStore();
                if(!data[currentDay]) data[currentDay] = { events: [], weather: {} };
                data[currentDay].weather.coords = tempCoords;
                data[currentDay].weather.addr = tempAddr;
                localStorage.setItem(key, JSON.stringify(data));
            }
            document.getElementById('map-overlay').style.display = 'none';
            renderCalendar();
            openModal(currentDay);
        }

        function renderCalendar() {
            const { data } = getStore(); const container = document.getElementById('main-calendar');
            const year = viewDate.getFullYear(), month = viewDate.getMonth();
            document.getElementById('year-title').innerText = `${year}. ${(month+1).toString().padStart(2,'0')}`;
            let html = '';
            ['SUN','MON','TUE','WED','THU','FRI','SAT'].forEach((d,i)=> html += `<div class="cal-header" style="color:${i===0?'#ff4d4d':i===6?'#4da6ff':'#888'}">${d}</div>`);
            const first = new Date(year, month, 1).getDay(); const last = new Date(year, month+1, 0).getDate();
            for(let i=0; i<first; i++) html += `<div class="cal-day prev-month"></div>`;
            for(let d=1; d<=last; d++) {
                const dD = data[d] || { events: [], weather: {} };
                let bH = Array(24).fill(0).map((_,i)=>{ const ev = (dD.events||[]).find(e => i>=e.start && i<e.end); return `<div style="background:${ev?ev.color:'#151515'}"></div>`; }).join('');
                let w = dD.weather || {};
                let locStr = w.addr ? w.addr.split(' ').slice(-1) : "";
                let wH = w.temp ? `<div class="weather-badge-main"><div class="w-line"><span style="color:#fff;">${w.min}/${w.max}</span></div><div class="w-line" style="color:var(--accent-blue);"><span class="w-loc-inline">${locStr}</span><span>${w.icon}</span></div></div>` : "";
                html += `<div class="cal-day" onclick="handleDayAction(${d})"><div class="day-num">${d}</div>${wH}<div class="time-bar">${bH}</div></div>`;
            }
            container.innerHTML = html; container.style.gridTemplateRows = `18px repeat(6, 1fr)`;
        }

        window.openModal = function(d) { 
            currentDay = d; 
            document.getElementById('modal-date-title').innerText = `${viewDate.getMonth()+1}.${d}`; 
            document.getElementById('input-modal').style.display = 'flex'; 
            startSlot = null; endSlot = null; initTime(); initPalette(); 
        };
        function closeModal() { document.getElementById('input-modal').style.display = 'none'; }
        function handleDayAction(d) { if(isStampMode) executeStampPaste(d); else openModal(d); }
        function activateStampMode() { isStampMode = true; document.body.classList.add('stamp-mode-active'); closeModal(); }
        function deactivateStampMode() { isStampMode = false; document.body.classList.remove('stamp-mode-active'); }
        function changeMonth(diff) { viewDate.setMonth(viewDate.getMonth()+diff); renderCalendar(); }
        
        function initTime() {
            const t = document.getElementById('time-picker'); t.innerHTML = '';
            for(let i=0; i<24; i++) {
                const b = document.createElement('div'); b.innerText = i; b.style.padding = '5px 0'; b.style.textAlign = 'center'; b.style.fontSize = '0.65rem'; b.style.background = '#1a1a1a'; b.style.border = '1px solid #333'; b.style.cursor = 'pointer';
                b.onclick = () => { if(startSlot === null) startSlot = i; else endSlot = i; updateTimeUI(); };
                t.appendChild(b);
            }
        }
        function updateTimeUI() {
            const btns = document.querySelectorAll('#time-picker div');
            btns.forEach((b, i) => { 
                const s = Math.min(startSlot, endSlot === null ? startSlot : endSlot);
                const e = Math.max(startSlot, endSlot === null ? startSlot : endSlot);
                b.style.background = (startSlot !== null && i >= s && i <= e) ? selectedColor : '#1a1a1a';
            });
        }
        function initPalette() {
            const p = document.getElementById('color-palette'); p.innerHTML = '';
            ['#0070FF', '#FF3B30', '#34C759', '#FFCC00', '#AF52DE', '#FF9500'].forEach(c => {
                const d = document.createElement('div'); d.style.background = c; d.style.height = '30px'; d.style.borderRadius = '4px'; d.style.border = selectedColor === c ? '2px solid white' : '1px solid #333';
                d.onclick = () => { selectedColor = c; initPalette(); };
                p.appendChild(d);
            });
        }
        function handleModeBtn(m) {
            if(m === 'add' && startSlot !== null) {
                const { key, data } = getStore();
                if(!data[currentDay]) data[currentDay] = { events: [], weather: {} };
                data[currentDay].events.push({ name: document.getElementById('ev-name').value, start: Math.min(startSlot, endSlot), end: Math.max(startSlot, endSlot), color: selectedColor });
                localStorage.setItem(key, JSON.stringify(data));
                renderCalendar(); closeModal();
            }
        }
        window.onload = renderCalendar;
    </script>
</body>
</html>